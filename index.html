<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Panorama</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
  <style>
  body {
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    position: absolute;
    height: 100%;
    width: 100%;

    background-color: black;
  }

  #map {
    /* position: absolute; */
    /* top: 0; */
    /* bottom: 0; */
    height: 100%;
    width: 100%;
  }

  #controls {
    height: 50px;
  }

  #controls #sequence {
    width: 60%;
  }
  </style>
</head>
<body>
<div id="map"></div>
<!-- <div id="controls">
  <input type="range" id="sequence" min="0" max="405" value="0" step="1" />
  <label id="sequence-label" for="sequence"></label>
  <span id="sequence-date"></span>
  <button id="start-animation">ðŸš—</button>
</div> -->
<script>
  function getPoint (coordinates) {
    return {
      type: 'FeatureCollection',
      features: [{
        type: 'Feature',
        properties: {},
        geometry: {
          type: 'Point',
          coordinates: coordinates
        }
      }]
    }
  }

  var feature

  var map = new mapboxgl.Map({
    container: 'map',
    hash: true,
    // style: {
    //   version: 8,
    //   sources: {
    //     amsterdam: {
    //       type: 'vector',
    //       tiles: [
    //         'https://t1.data.amsterdam.nl/wm/{z}/{x}/{y}.mvt',
    //         'https://t2.data.amsterdam.nl/wm/{z}/{x}/{y}.mvt',
    //         'https://t3.data.amsterdam.nl/wm/{z}/{x}/{y}.mvt',
    //         'https://t4.data.amsterdam.nl/wm/{z}/{x}/{y}.mvt'
    //       ]
    //     }
    //   },
    //   layers: [{
    //     id: 'test',
    //     type: 'line',
    //     source: 'amsterdam',
    //     'source-layer': 'sequences',
    //     minzoom: 0,
    //     maxzoom: 22
    //   }]
    // },
    style: {
      version: 8,
      sources: {
    //     amsterdam: {
    //       https://t4.data.amsterdam.nl/topo_rd_light/9/234/272.png
        // }
      },
      layers: []
    },
    center: [4.922, 52.369],
    // maxBounds: [[4.660288, 52.216390], [5.376239,52.488702]],
    maxBounds: [[4.5, 52.0], [5.54, 52.7]],
    zoom: 10,
    minZoom: 8,
    maxZoom: 19,
    scrollZoom: false // TODO: use URL param
  })

  map.on('load', function () {
    var nav = new mapboxgl.NavigationControl()
    map.addControl(nav, 'top-left')


    var origin = window.location.origin
    var pathname = window.location.pathname
    var tileUrl = origin + pathname + 'tiles//{z}/{x}/{y}.pbf'

    map.addLayer({
      id: 'sequences',
      type: 'line',
      // maxzoom: 19,
      source: {
        type: 'vector',
        tiles: [tileUrl],
        maxzoom: 14
      },
      'source-layer': 'sequences',
      layout: {
        "line-cap": "round",
        "line-join": "round"
      },
      paint: {
        'line-opacity': 0.6,
        'line-color': ['case',
          ['==', ['get', 'surface'], 'water'], '#00a9ff',
          '#26af00'
        ],
        'line-width': {
          // 'base': 1,
          'stops': [[8, 0.4], [17, 3]]
        }
      }
    })


    map.on('mousemove', function (e) {
      var features = map.queryRenderedFeatures(e.point)
      if (features[0]) {
        var id = features[0].properties.id
        var capturedAt = features[0].properties.capturedAt

        var path = capturedAt.slice(0, 10).replace(new RegExp('-', 'g'), '/')

        var url = 'http://localhost:8082/sequences/' + path + '/' + id + '.geojson'
        console.log(url)
      }
    })

    // map.addLayer({
    //   id: 'panorama',
    //   type: 'heatmap',
    //   type: 'circle',
    //   source: {
    //     type: 'vector',
    //     tiles: ["http://localhost:4000/{z}/{x}/{y}.pbf"]
    //   },
    //   'source-layer': 'panorama',
    //   // paint: {
    //   //   'heatmap-radius': 15
    //   // }
    //   paint: {
    //     'circle-color': '#FF0A66',
    //     'circle-radius': 2,
    //     // Add data-driven styles for circle radius
    //     // 'circle-radius': {
    //     //   property: '8HrPedVol',
    //     //   type: 'exponential',
    //     //   stops: [
    //     //     [124, 2],
    //     //     [34615, 10]
    //     //   ]
    //     // },
    //     'circle-opacity': 0.5
    //   }
    // })

    map.addSource('point', {
      type: 'geojson',
      data: getPoint([52.367, 4.915])
    })

    map.addLayer({
      id: 'point',
      source: 'point',
      type: 'symbol',
      layout: {
        'icon-image': 'car-15',
        'icon-rotate': ['get', 'bearing'],
        'icon-rotation-alignment': 'map',
        'icon-allow-overlap': true,
        'icon-ignore-placement': true
      }
    })
  })

  // document.getElementById('sequence')
  //   .addEventListener('input', function () {
  //     var sequenceId = this.value
  //     var sequenceIdFilter = ['==', 'sequenceId', parseInt(sequenceId)]

  //     map.setFilter('sequences', sequenceIdFilter)

  //     feature = map.querySourceFeatures('sequences', {
  //       sourceLayer: 'sequences',
  //       filter: sequenceIdFilter
  //     })[0]

  //     var date = feature ? feature.properties.timestamp.slice(0, 10) : ''

  //     document.getElementById('sequence-label').innerText = sequenceId
  //     document.getElementById('sequence-date').innerText = date

  //     if (feature) {
  //       // startAnimation(feature)
  //     }
  //   })

  // document.getElementById('start-animation').addEventListener('click', function () {
  //     console.log('vhip')
  //     startAnimation(feature)
  //   })

  // function startAnimation (feature) {
  //   var steps = 1500
  //   var counter = 0

  //   var units = {units: 'meters'}

  //   function toLineString (coordinates) {
  //     return {
  //       type: 'LineString',
  //       coordinates: coordinates
  //     }
  //   }

  //   var lineStrings = feature.geometry.coordinates
  //     .filter(function (coordinates) {
  //       return coordinates.length > 1
  //     })
  //     .map(toLineString)

  //   // TODO: PAS sequences.js aan, alleen maar meer dan 1 punt in linestrinfg

  //   var distances = lineStrings
  //     .map((lineString) => turf.length(lineString, units))

  //   var accDistances = distances
  //     .reduce((a, x, i) => [...a, x + (a[i-1] || 0)], [])

  //   var distance = distances.reduce(function (acc, val) {
  //     return acc + val
  //   }, 0)

  //   var point = getPoint([52.367, 4.915])

  //   function animate () {
  //     var currentDistance = distance / steps * counter

  //     var lineStringIndex = 0
  //     while (accDistances[lineStringIndex] < currentDistance) {
  //       lineStringIndex += 1
  //     }

  //     var lineString = lineStrings[lineStringIndex]
  //     var distanceBefore = lineStringIndex > 0 ? accDistances[lineStringIndex - 1] : 0

  //     point.features[0].geometry.coordinates = turf.along(lineString, currentDistance - distanceBefore, units).geometry.coordinates

  //     // point.features[0].properties.bearing = turf.bearing(
  //     //   turf.point(feature.geometry.coordinates[0][counter >= steps ? counter - 1 : counter]),
  //     //   turf.point(feature.geometry.coordinates[0][counter >= steps ? counter : counter + 1])
  //     // )

  //     point.features[0].properties.bearing = 0

  //     map.getSource('point').setData(point)

  //     if (counter < steps) {
  //       requestAnimationFrame(animate)
  //     }

  //     counter = counter + 1
  //   }

  //   animate()
  // }
</script>
</body>
</html>